name: Weather Scraper

on:
  schedule:
    - cron: "0 0 * * *"   # ch·∫°y 0h UTC (7h s√°ng VN)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ L·∫•y code
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ C√†i JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3Ô∏è‚É£ Build v√† ch·∫°y ch∆∞∆°ng tr√¨nh v·ªõi retry t·ªëi ƒëa 5 l·∫ßn
      - name: Build & Run Weather Scraper (max 5 retries)
        id: run_scraper
        run: |
          MAX_RETRIES=5
          COUNT=1
          STATUS="failed"

          while [ $COUNT -le $MAX_RETRIES ]; do
            echo "üîÅ L·∫ßn th·ª≠ $COUNT / $MAX_RETRIES..."
            if mvn -q compile && mvn -q exec:java -Dexec.mainClass="weather_scraper.WeatherScraper"; then
              STATUS="success"
              echo "‚úÖ Th√†nh c√¥ng ·ªü l·∫ßn th·ª≠ th·ª© $COUNT."
              break
            else
              echo "‚ö†Ô∏è Th·∫•t b·∫°i l·∫ßn $COUNT."
              COUNT=$((COUNT+1))
              sleep 5  # ngh·ªâ 5 gi√¢y gi·ªØa c√°c l·∫ßn th·ª≠
            fi
          done

          echo "status=$STATUS" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Ghi log k·∫øt qu·∫£ h√†ng ng√†y
      - name: Append daily run result to log
        run: |
          DATE=$(date '+%Y-%m-%d %H:%M')
          if [ "${{ steps.run_scraper.outputs.status }}" = "success" ]; then
            echo "[$DATE] ‚úÖ Th√†nh c√¥ng - ƒê√£ scrape d·ªØ li·ªáu th·ªùi ti·∫øt." >> run_log.txt
          else
            echo "[$DATE] ‚ùå Th·∫•t b·∫°i sau 5 l·∫ßn th·ª≠ - C√≥ l·ªói khi ch·∫°y scraper." >> run_log.txt
          fi

      # 5Ô∏è‚É£ Commit l·∫°i k·∫øt qu·∫£
      - name: Commit results
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add weather_log.csv run_log.txt
          git commit -m "Add daily weather data (CSV) + run log" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

